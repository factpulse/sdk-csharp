/*
 * FactPulse REST API
 *
 *  REST API for electronic invoicing in France: Factur-X, AFNOR PDP/PA, electronic signatures.  ## üéØ Main Features  ### üìÑ Factur-X Invoice Generation - **Formats**: XML only or PDF/A-3 with embedded XML - **Profiles**: MINIMUM, BASIC, EN16931, EXTENDED - **Standards**: EN 16931 (EU directive 2014/55), ISO 19005-3 (PDF/A-3), CII (UN/CEFACT) - **üÜï Simplified Format**: Generation from SIRET + auto-enrichment (Chorus Pro API + Business Search)  ### ‚úÖ Validation and Compliance - **XML Validation**: Schematron (45 to 210+ rules depending on profile) - **PDF Validation**: PDF/A-3, Factur-X XMP metadata, electronic signatures - **VeraPDF**: Strict PDF/A validation (146+ ISO 19005-3 rules) - **Asynchronous Processing**: Celery support for heavy validations (VeraPDF)  ### üì° AFNOR PDP/PA Integration (XP Z12-013) - **Flow Submission**: Send invoices to Partner Dematerialization Platforms - **Flow Search**: View submitted invoices - **Download**: Retrieve PDF/A-3 with XML - **Directory Service**: Company search (SIREN/SIRET) - **Multi-client**: Support for multiple PDP configs per user (stored credentials or zero-storage)  ### ‚úçÔ∏è PDF Electronic Signature - **Standards**: PAdES-B-B, PAdES-B-T (RFC 3161 timestamping), PAdES-B-LT (long-term archival) - **eIDAS Levels**: SES (self-signed), AdES (commercial CA), QES (QTSP) - **Validation**: Cryptographic integrity and certificate verification - **Certificate Generation**: Self-signed X.509 certificates for testing  ### üîÑ Asynchronous Processing - **Celery**: Asynchronous generation, validation and signing - **Polling**: Status tracking via `/tasks/{task_id}/status` - **No timeout**: Ideal for large files or heavy validations  ## üîí Authentication  All requests require a **JWT token** in the Authorization header: ``` Authorization: Bearer YOUR_JWT_TOKEN ```  ### How to obtain a JWT token?  #### üîë Method 1: `/api/token/` API (Recommended)  **URL:** `https://www.factpulse.fr/api/token/`  This method is **recommended** for integration in your applications and CI/CD workflows.  **Prerequisites:** Having set a password on your account  **For users registered via email/password:** - You already have a password, use it directly  **For users registered via OAuth (Google/GitHub):** - You must first set a password at: https://www.factpulse.fr/accounts/password/set/ - Once the password is created, you can use the API  **Request example:** ```bash curl -X POST https://www.factpulse.fr/api/token/ \\   -H \"Content-Type: application/json\" \\   -d '{     \"username\": \"your_email@example.com\",     \"password\": \"your_password\"   }' ```  **Optional `client_uid` parameter:**  To select credentials for a specific client (PA/PDP, Chorus Pro, signing certificates), add `client_uid`:  ```bash curl -X POST https://www.factpulse.fr/api/token/ \\   -H \"Content-Type: application/json\" \\   -d '{     \"username\": \"your_email@example.com\",     \"password\": \"your_password\",     \"client_uid\": \"550e8400-e29b-41d4-a716-446655440000\"   }' ```  The `client_uid` will be included in the JWT and allow the API to automatically use: - AFNOR/PDP credentials configured for this client - Chorus Pro credentials configured for this client - Electronic signature certificates configured for this client  **Response:** ```json {   \"access\": \"eyJ0eXAiOiJKV1QiLCJhbGc...\",  // Access token (validity: 30 min)   \"refresh\": \"eyJ0eXAiOiJKV1QiLCJhbGc...\"  // Refresh token (validity: 7 days) } ```  **Advantages:** - ‚úÖ Full automation (CI/CD, scripts) - ‚úÖ Programmatic token management - ‚úÖ Refresh token support for automatic access renewal - ‚úÖ Easy integration in any language/tool  #### üñ•Ô∏è Method 2: Dashboard Generation (Alternative)  **URL:** https://www.factpulse.fr/dashboard/  This method is suitable for quick tests or occasional use via the graphical interface.  **How it works:** - Log in to the dashboard - Use the \"Generate Test Token\" or \"Generate Production Token\" buttons - Works for **all** users (OAuth and email/password), without requiring a password  **Token types:** - **Test Token**: 24h validity, 1000 calls/day quota (free) - **Production Token**: 7 days validity, quota based on your plan  **Advantages:** - ‚úÖ Quick for API testing - ‚úÖ No password required - ‚úÖ Simple visual interface  **Disadvantages:** - ‚ùå Requires manual action - ‚ùå No refresh token - ‚ùå Less suited for automation  ### üìö Full Documentation  For more information on authentication and API usage: https://www.factpulse.fr/documentation-api/     
 *
 * The version of the OpenAPI document: 1.0.0
 * Generated by: https://github.com/openapitools/openapi-generator.git
 */

#nullable enable

using System;
using System.Collections.Generic;
using System.Linq;
using System.Text.Json;
using System.Text.Json.Serialization;
using System.Net.Http;
using Microsoft.Extensions.DependencyInjection;
using FactPulse.SDK.Api;
using FactPulse.SDK.Model;

namespace FactPulse.SDK.Client
{
    /// <summary>
    /// Provides hosting configuration for FactPulse.SDK
    /// </summary>
    public class HostConfiguration
    {
        private readonly IServiceCollection _services;
        private readonly JsonSerializerOptions _jsonOptions = new JsonSerializerOptions();

        internal bool HttpClientsAdded { get; private set; }

        /// <summary>
        /// Instantiates the class 
        /// </summary>
        /// <param name="services"></param>
        public HostConfiguration(IServiceCollection services)
        {
            _services = services;
            _jsonOptions.Converters.Add(new JsonStringEnumConverter());
            _jsonOptions.Converters.Add(new DateTimeJsonConverter());
            _jsonOptions.Converters.Add(new DateTimeNullableJsonConverter());
            _jsonOptions.Converters.Add(new DateOnlyJsonConverter());
            _jsonOptions.Converters.Add(new DateOnlyNullableJsonConverter());
            _jsonOptions.Converters.Add(new AFNORCredentialsJsonConverter());
            _jsonOptions.Converters.Add(new AFNORDestinationJsonConverter());
            _jsonOptions.Converters.Add(new AFNORHealthCheckResponseJsonConverter());
            _jsonOptions.Converters.Add(new AFNORResultJsonConverter());
            _jsonOptions.Converters.Add(new APIErrorJsonConverter());
            _jsonOptions.Converters.Add(new APIProfileJsonConverter());
            _jsonOptions.Converters.Add(new APIProfileNullableJsonConverter());
            _jsonOptions.Converters.Add(new AcknowledgmentStatusJsonConverter());
            _jsonOptions.Converters.Add(new AcknowledgmentStatusNullableJsonConverter());
            _jsonOptions.Converters.Add(new AllowanceReasonCodeJsonConverter());
            _jsonOptions.Converters.Add(new AllowanceReasonCodeNullableJsonConverter());
            _jsonOptions.Converters.Add(new AmountDueJsonConverter());
            _jsonOptions.Converters.Add(new BoundingBoxSchemaJsonConverter());
            _jsonOptions.Converters.Add(new CeleryStatusJsonConverter());
            _jsonOptions.Converters.Add(new CeleryStatusNullableJsonConverter());
            _jsonOptions.Converters.Add(new CertificateInfoResponseJsonConverter());
            _jsonOptions.Converters.Add(new ChorusProDestinationJsonConverter());
            _jsonOptions.Converters.Add(new ChorusProResultJsonConverter());
            _jsonOptions.Converters.Add(new DestinationJsonConverter());
            _jsonOptions.Converters.Add(new DocumentTypeJsonConverter());
            _jsonOptions.Converters.Add(new DocumentTypeNullableJsonConverter());
            _jsonOptions.Converters.Add(new ElectronicAddressJsonConverter());
            _jsonOptions.Converters.Add(new EnrichedInvoiceInfoJsonConverter());
            _jsonOptions.Converters.Add(new ErrorLevelJsonConverter());
            _jsonOptions.Converters.Add(new ErrorLevelNullableJsonConverter());
            _jsonOptions.Converters.Add(new ErrorSourceJsonConverter());
            _jsonOptions.Converters.Add(new ErrorSourceNullableJsonConverter());
            _jsonOptions.Converters.Add(new FacturXPDFInfoJsonConverter());
            _jsonOptions.Converters.Add(new FactureElectroniqueRestApiSchemasChorusProChorusProCredentialsJsonConverter());
            _jsonOptions.Converters.Add(new FactureElectroniqueRestApiSchemasProcessingChorusProCredentialsJsonConverter());
            _jsonOptions.Converters.Add(new FactureFacturXJsonConverter());
            _jsonOptions.Converters.Add(new FieldStatusJsonConverter());
            _jsonOptions.Converters.Add(new FieldStatusNullableJsonConverter());
            _jsonOptions.Converters.Add(new FlowDirectionJsonConverter());
            _jsonOptions.Converters.Add(new FlowDirectionNullableJsonConverter());
            _jsonOptions.Converters.Add(new FlowProfileJsonConverter());
            _jsonOptions.Converters.Add(new FlowProfileNullableJsonConverter());
            _jsonOptions.Converters.Add(new FlowSummaryJsonConverter());
            _jsonOptions.Converters.Add(new FlowSyntaxJsonConverter());
            _jsonOptions.Converters.Add(new FlowSyntaxNullableJsonConverter());
            _jsonOptions.Converters.Add(new FlowTypeJsonConverter());
            _jsonOptions.Converters.Add(new FlowTypeNullableJsonConverter());
            _jsonOptions.Converters.Add(new GenerateCertificateRequestJsonConverter());
            _jsonOptions.Converters.Add(new GenerateCertificateResponseJsonConverter());
            _jsonOptions.Converters.Add(new GetChorusProIdRequestJsonConverter());
            _jsonOptions.Converters.Add(new GetChorusProIdResponseJsonConverter());
            _jsonOptions.Converters.Add(new GetInvoiceRequestJsonConverter());
            _jsonOptions.Converters.Add(new GetInvoiceResponseJsonConverter());
            _jsonOptions.Converters.Add(new GetStructureRequestJsonConverter());
            _jsonOptions.Converters.Add(new GetStructureResponseJsonConverter());
            _jsonOptions.Converters.Add(new GlobalAllowanceAmountJsonConverter());
            _jsonOptions.Converters.Add(new HTTPValidationErrorJsonConverter());
            _jsonOptions.Converters.Add(new IncomingInvoiceJsonConverter());
            _jsonOptions.Converters.Add(new IncomingSupplierJsonConverter());
            _jsonOptions.Converters.Add(new InvoiceFormatJsonConverter());
            _jsonOptions.Converters.Add(new InvoiceFormatNullableJsonConverter());
            _jsonOptions.Converters.Add(new InvoiceLineJsonConverter());
            _jsonOptions.Converters.Add(new InvoiceLineAllowanceAmountJsonConverter());
            _jsonOptions.Converters.Add(new InvoiceNoteJsonConverter());
            _jsonOptions.Converters.Add(new InvoiceReferencesJsonConverter());
            _jsonOptions.Converters.Add(new InvoiceStatusJsonConverter());
            _jsonOptions.Converters.Add(new InvoiceTotalsJsonConverter());
            _jsonOptions.Converters.Add(new InvoiceTotalsPrepaymentJsonConverter());
            _jsonOptions.Converters.Add(new InvoiceTypeCodeJsonConverter());
            _jsonOptions.Converters.Add(new InvoiceTypeCodeNullableJsonConverter());
            _jsonOptions.Converters.Add(new InvoicingFrameworkJsonConverter());
            _jsonOptions.Converters.Add(new InvoicingFrameworkCodeJsonConverter());
            _jsonOptions.Converters.Add(new InvoicingFrameworkCodeNullableJsonConverter());
            _jsonOptions.Converters.Add(new LineNetAmountJsonConverter());
            _jsonOptions.Converters.Add(new MandatoryNoteSchemaJsonConverter());
            _jsonOptions.Converters.Add(new ManualRateJsonConverter());
            _jsonOptions.Converters.Add(new ManualVatRateJsonConverter());
            _jsonOptions.Converters.Add(new OperationNatureJsonConverter());
            _jsonOptions.Converters.Add(new OperationNatureNullableJsonConverter());
            _jsonOptions.Converters.Add(new OutputFormatJsonConverter());
            _jsonOptions.Converters.Add(new OutputFormatNullableJsonConverter());
            _jsonOptions.Converters.Add(new PDFValidationResultAPIJsonConverter());
            _jsonOptions.Converters.Add(new PDPCredentialsJsonConverter());
            _jsonOptions.Converters.Add(new PageDimensionsSchemaJsonConverter());
            _jsonOptions.Converters.Add(new PayeeJsonConverter());
            _jsonOptions.Converters.Add(new PaymentMeansJsonConverter());
            _jsonOptions.Converters.Add(new PaymentMeansNullableJsonConverter());
            _jsonOptions.Converters.Add(new PostalAddressJsonConverter());
            _jsonOptions.Converters.Add(new ProcessingOptionsJsonConverter());
            _jsonOptions.Converters.Add(new QuantityJsonConverter());
            _jsonOptions.Converters.Add(new RecipientJsonConverter());
            _jsonOptions.Converters.Add(new SchemeIDJsonConverter());
            _jsonOptions.Converters.Add(new SchemeIDNullableJsonConverter());
            _jsonOptions.Converters.Add(new SearchFlowRequestJsonConverter());
            _jsonOptions.Converters.Add(new SearchFlowResponseJsonConverter());
            _jsonOptions.Converters.Add(new SearchServicesResponseJsonConverter());
            _jsonOptions.Converters.Add(new SearchStructureRequestJsonConverter());
            _jsonOptions.Converters.Add(new SearchStructureResponseJsonConverter());
            _jsonOptions.Converters.Add(new SignatureInfoJsonConverter());
            _jsonOptions.Converters.Add(new SignatureInfoAPIJsonConverter());
            _jsonOptions.Converters.Add(new SignatureParametersJsonConverter());
            _jsonOptions.Converters.Add(new SimplifiedInvoiceDataJsonConverter());
            _jsonOptions.Converters.Add(new StructureInfoJsonConverter());
            _jsonOptions.Converters.Add(new StructureParametersJsonConverter());
            _jsonOptions.Converters.Add(new StructureServiceJsonConverter());
            _jsonOptions.Converters.Add(new SubmissionModeJsonConverter());
            _jsonOptions.Converters.Add(new SubmissionModeNullableJsonConverter());
            _jsonOptions.Converters.Add(new SubmitCompleteInvoiceRequestJsonConverter());
            _jsonOptions.Converters.Add(new SubmitCompleteInvoiceResponseJsonConverter());
            _jsonOptions.Converters.Add(new SubmitFlowRequestJsonConverter());
            _jsonOptions.Converters.Add(new SubmitFlowResponseJsonConverter());
            _jsonOptions.Converters.Add(new SubmitInvoiceRequestJsonConverter());
            _jsonOptions.Converters.Add(new SubmitInvoiceResponseJsonConverter());
            _jsonOptions.Converters.Add(new SupplementaryAttachmentJsonConverter());
            _jsonOptions.Converters.Add(new SupplierJsonConverter());
            _jsonOptions.Converters.Add(new TaskResponseJsonConverter());
            _jsonOptions.Converters.Add(new TaskStatusJsonConverter());
            _jsonOptions.Converters.Add(new TaxableAmountJsonConverter());
            _jsonOptions.Converters.Add(new TotalGrossAmountJsonConverter());
            _jsonOptions.Converters.Add(new TotalNetAmountJsonConverter());
            _jsonOptions.Converters.Add(new TotalVATAmountJsonConverter());
            _jsonOptions.Converters.Add(new UnitNetPriceJsonConverter());
            _jsonOptions.Converters.Add(new UnitOfMeasureJsonConverter());
            _jsonOptions.Converters.Add(new UnitOfMeasureNullableJsonConverter());
            _jsonOptions.Converters.Add(new VATAccountingCodeJsonConverter());
            _jsonOptions.Converters.Add(new VATAccountingCodeNullableJsonConverter());
            _jsonOptions.Converters.Add(new VATAmountJsonConverter());
            _jsonOptions.Converters.Add(new VATCategoryJsonConverter());
            _jsonOptions.Converters.Add(new VATCategoryNullableJsonConverter());
            _jsonOptions.Converters.Add(new VATLineJsonConverter());
            _jsonOptions.Converters.Add(new ValidationErrorJsonConverter());
            _jsonOptions.Converters.Add(new ValidationErrorDetailJsonConverter());
            _jsonOptions.Converters.Add(new ValidationErrorLocInnerJsonConverter());
            _jsonOptions.Converters.Add(new ValidationErrorResponseJsonConverter());
            _jsonOptions.Converters.Add(new ValidationSuccessResponseJsonConverter());
            _jsonOptions.Converters.Add(new VatAmountJsonConverter());
            _jsonOptions.Converters.Add(new VerificationSuccessResponseJsonConverter());
            _jsonOptions.Converters.Add(new VerifiedFieldSchemaJsonConverter());
            JsonSerializerOptionsProvider jsonSerializerOptionsProvider = new(_jsonOptions);
            _services.AddSingleton(jsonSerializerOptionsProvider);
            _services.AddSingleton<IApiFactory, ApiFactory>();
            _services.AddSingleton<AFNORPDPPAApiEvents>();
            _services.AddSingleton<AFNORPDPPADirectoryServiceApiEvents>();
            _services.AddSingleton<AFNORPDPPAFlowServiceApiEvents>();
            _services.AddSingleton<ChorusProApiEvents>();
            _services.AddSingleton<HealthApiEvents>();
            _services.AddSingleton<InvoiceProcessingApiEvents>();
            _services.AddSingleton<PDFXMLVerificationApiEvents>();
            _services.AddSingleton<UserApiEvents>();
        }

        /// <summary>
        /// Configures the HttpClients.
        /// </summary>
        /// <param name="client"></param>
        /// <param name="builder"></param>
        /// <returns></returns>
        public HostConfiguration AddApiHttpClients
        (
            Action<HttpClient>? client = null, Action<IHttpClientBuilder>? builder = null)
        {
            if (client == null)
                client = c => c.BaseAddress = new Uri(ClientUtils.BASE_ADDRESS);

            List<IHttpClientBuilder> builders = new List<IHttpClientBuilder>();

            builders.Add(_services.AddHttpClient<IAFNORPDPPAApi, AFNORPDPPAApi>(client));
            builders.Add(_services.AddHttpClient<IAFNORPDPPADirectoryServiceApi, AFNORPDPPADirectoryServiceApi>(client));
            builders.Add(_services.AddHttpClient<IAFNORPDPPAFlowServiceApi, AFNORPDPPAFlowServiceApi>(client));
            builders.Add(_services.AddHttpClient<IChorusProApi, ChorusProApi>(client));
            builders.Add(_services.AddHttpClient<IHealthApi, HealthApi>(client));
            builders.Add(_services.AddHttpClient<IInvoiceProcessingApi, InvoiceProcessingApi>(client));
            builders.Add(_services.AddHttpClient<IPDFXMLVerificationApi, PDFXMLVerificationApi>(client));
            builders.Add(_services.AddHttpClient<IUserApi, UserApi>(client));
            
            if (builder != null)
                foreach (IHttpClientBuilder instance in builders)
                    builder(instance);

            HttpClientsAdded = true;

            return this;
        }

        /// <summary>
        /// Configures the JsonSerializerSettings
        /// </summary>
        /// <param name="options"></param>
        /// <returns></returns>
        public HostConfiguration ConfigureJsonOptions(Action<JsonSerializerOptions> options)
        {
            options(_jsonOptions);

            return this;
        }

        /// <summary>
        /// Adds tokens to your IServiceCollection
        /// </summary>
        /// <typeparam name="TTokenBase"></typeparam>
        /// <param name="token"></param>
        /// <returns></returns>
        public HostConfiguration AddTokens<TTokenBase>(TTokenBase token) where TTokenBase : TokenBase
        {
            return AddTokens(new TTokenBase[]{ token });
        }

        /// <summary>
        /// Adds tokens to your IServiceCollection
        /// </summary>
        /// <typeparam name="TTokenBase"></typeparam>
        /// <param name="tokens"></param>
        /// <returns></returns>
        public HostConfiguration AddTokens<TTokenBase>(IEnumerable<TTokenBase> tokens) where TTokenBase : TokenBase
        {
            TokenContainer<TTokenBase> container = new TokenContainer<TTokenBase>(tokens);
            _services.AddSingleton(services => container);

            return this;
        }

        /// <summary>
        /// Adds a token provider to your IServiceCollection
        /// </summary>
        /// <typeparam name="TTokenProvider"></typeparam>
        /// <typeparam name="TTokenBase"></typeparam>
        /// <returns></returns>
        public HostConfiguration UseProvider<TTokenProvider, TTokenBase>() 
            where TTokenProvider : TokenProvider<TTokenBase>
            where TTokenBase : TokenBase
        {
            _services.AddSingleton<TTokenProvider>();
            _services.AddSingleton<TokenProvider<TTokenBase>>(services => services.GetRequiredService<TTokenProvider>());

            return this;
        }
    }
}
